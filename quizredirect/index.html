<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Link Redirector (robust)</title>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Fetch the file
    fetch('QuizzerRedirectAnswers.txt')
      .then(response => response.text())
      .then(text => {
        // Try to extract all URL + array pairs from the entire file first
        // Matches patterns like: https://example/... , [1,2,3]
        const pairRegex = /(https?:\/\/[^\s,]+)\s*,\s*(\[[^\]]*\])/g;
        let matches = [];
        let m;
        while ((m = pairRegex.exec(text)) !== null) {
            matches.push({ url: m[1].trim(), answersStr: m[2].trim() });
        }

        // Fallback: try line-by-line after stripping HTML tags (useful if GitHub returned an HTML page)
        if (matches.length === 0) {
            const lines = text.split('\n');
            for (let rawLine of lines) {
                let line = rawLine.replace(/<[^>]*>/g, '').trim(); // remove tags
                if (!line) continue;
                let mm = line.match(/(https?:\/\/[^\s,]+)\s*,\s*(\[[^\]]*\])/);
                if (mm) matches.push({ url: mm[1].trim(), answersStr: mm[2].trim() });
            }
        }

        if (matches.length === 0) {
            console.error('No valid "URL, [answers]" lines found in the fetched file.');
            return;
        }

        // Helper to get current week number (same logic you had)
        function getCurrentWeek() {
            let now = new Date();
            let startOfYear = new Date(now.getFullYear(), 0, 1);
            let days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            return Math.ceil((days + startOfYear.getDay() + 1) / 7);
        }

        let currentWeek = getCurrentWeek();
        let storedWeek = localStorage.getItem("visitedWeek");
        if (storedWeek !== String(currentWeek)) {
            localStorage.setItem("visitedWeek", String(currentWeek));
            localStorage.setItem("visitedURLs", JSON.stringify([]));
        }

        // Load visited URLs (not raw lines) so we avoid mismatches from HTML or extra text
        let visited = JSON.parse(localStorage.getItem("visitedURLs") || "[]");

        // Filter matches to only those with URLs not visited this week
        let remaining = matches.filter(p => !visited.includes(p.url));

        if (remaining.length === 0) {
            alert("All links visited this week. Will restart next week.");
            return;
        }

        // Pick random remaining pair
        let chosen = remaining[Math.floor(Math.random() * remaining.length)];

        // Save visited URL
        visited.push(chosen.url);
        localStorage.setItem("visitedURLs", JSON.stringify(visited));

        // Parse answers string safely
        let answers;
        try {
            // normalize single quotes if any, remove stray spaces
            let s = chosen.answersStr.replace(/'/g, '"').trim();
            answers = JSON.parse(s);
            if (!Array.isArray(answers)) throw new Error("Parsed answers is not an array");
        } catch (err) {
            console.error("Failed to parse answers for", chosen.url, "->", chosen.answersStr, err);
            return;
        }

        // Redirect with JSON-encoded, URI-encoded answers in the hash
        let redirectUrl = chosen.url + "#answers=" + encodeURIComponent(JSON.stringify(answers));
        console.log("Redirecting to:", redirectUrl);
        window.location.assign(redirectUrl);

        // optional fallback reload in case something goes wrong
        setTimeout(() => { location.reload(); }, 20000);
    })
    .catch(err => console.error('Failed to load links:', err));
});
</script>
</head>
<body>
<p>Redirecting...</p>
</body>
</html>
