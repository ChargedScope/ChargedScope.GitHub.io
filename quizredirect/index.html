<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Link Redirector</title>
<script>
document.addEventListener("DOMContentLoaded", function() {
    fetch('QuizzerRedirectNumbers.txt')
      .then(response => response.text())
      .then(text => {
        const lines = text.split('\n').map(line => line.trim()).filter(Boolean);

        function getCurrentWeek() {
            let now = new Date();
            let startOfYear = new Date(now.getFullYear(), 0, 1);
            let days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            return Math.ceil((days + startOfYear.getDay() + 1) / 7);
        }

        let currentWeek = getCurrentWeek();
        let storedWeek = localStorage.getItem("visitedWeek");

        if (storedWeek !== String(currentWeek)) {
            localStorage.setItem("visitedWeek", String(currentWeek));
            localStorage.setItem("visitedLines", JSON.stringify([]));
        }

        let visited = JSON.parse(localStorage.getItem("visitedLines") || "[]");
        let remaining = lines.filter(line => !visited.includes(line));

        if (remaining.length === 0) {
            alert("All links visited! Will restart next week");
            return;
        }

        let chosenLine = remaining[Math.floor(Math.random() * remaining.length)];
        visited.push(chosenLine);
        localStorage.setItem("visitedLines", JSON.stringify(visited));

        // Parse "url, [answers]"
        let [url, answersStr] = chosenLine.split(",");
        url = url.trim();
        let answers = JSON.parse(answersStr.trim()); // convert to array

        // Put back as clean JSON
        let redirectUrl = url + "#answers=" + encodeURIComponent(JSON.stringify(answers));

        window.location.assign(redirectUrl);

        // Optional auto-refresh
        setTimeout(() => {
            location.reload();
        }, 20000);
    })
    .catch(err => console.error('Failed to load links:', err));
});
</script>
</head>
<body>
<p>Redirecting...</p>
</body>
</html>
